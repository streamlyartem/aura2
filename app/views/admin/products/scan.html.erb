<h2>ðŸ“· Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´</h2>

<div id="reader" style="width:100%; max-width:420px"></div>
<p>Ð¡Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´: <span id="result"></span></p>

<div id="new-product-form" style="display:none;">
  <%= form_with url: admin_products_path, method: :post, local: true, scope: :product do |f| %>
    <%= f.label :sku, "Ð¡Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´" %>
    <%= f.text_field :sku, id: "product_sku" %>

    <%= f.label :name, "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð°" %>
    <%= f.text_field :name %>

    <%= f.submit "Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚" %>
  <% end %>
</div>

<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const resultElem = document.getElementById("result");
    const formDiv   = document.getElementById("new-product-form");
    const skuField  = document.getElementById("product_sku");

    const html5QrCode = new Html5Qrcode("reader");

    const config = {
      fps: 10,
      qrbox: 250,
      formatsToSupport: [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.QR_CODE
      ]
    };

    function handleDecoded(decodedText) {
      resultElem.innerText = decodedText;

      fetch(`/admin/products/check_sku.json?sku=${encodeURIComponent(decodedText)}`, {
        headers: { "Accept": "application/json" }
      })
      .then(r => r.json())
      .then(data => {
        if (data.exists) {
          window.location.href = data.edit_url;
        } else {
          skuField.value = decodedText;
          formDiv.style.display = "block";
        }
      });
    }

    function onScanSuccess(decodedText/*, decodedResult */) {
      html5QrCode.stop().catch(() => {});
      handleDecoded(decodedText);
    }

    html5QrCode.start(
      { facingMode: "environment" }, // ÐºÐ°Ð¼ÐµÑ€Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°
      config,
      onScanSuccess,
      (err) => { /* Ð¼Ð¾Ð¶Ð½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ */ }
    ).catch(err => {
      console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ ÐºÐ°Ð¼ÐµÑ€Ñ‹:", err);
      const btn = document.createElement("button");
      btn.textContent = "Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ";
      btn.onclick = () => {
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
      };
      document.getElementById("reader").appendChild(btn);
    });
  });
</script>
